<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ticket.mapper.OrderMapper">

    <!-- 分页查询用户订单 -->
    <select id="selectUserOrderPage" resultType="com.ticket.model.dto.response.OrderListResponseDTO">
        SELECT
        o.id,
        o.order_no,
        p.name AS performanceName,
        DATE_FORMAT(s.session_time, '%Y-%m-%d %H:%i') AS sessionTime,
        o.grade_name,
        o.count,
        o.total_amount,
        os.status_desc AS statusDesc,
        o.create_time,
        o.expire_time
        FROM `order` o
        LEFT JOIN performance p ON o.performance_id = p.id
        LEFT JOIN performance_session s ON o.session_id = s.id
        LEFT JOIN (
        SELECT 0 AS code, '待支付' AS status_desc UNION ALL
        SELECT 1 AS code, '已支付' AS status_desc UNION ALL
        SELECT 2 AS code, '已取消' AS status_desc UNION ALL
        SELECT 3 AS code, '已完成' AS status_desc UNION ALL
        SELECT 4 AS code, '已退款' AS status_desc
        ) os ON o.status = os.code
        WHERE o.user_id = ${@com.ticket.util.UserContext@getCurrentUserId()}
        <!-- 确保status条件严格生效：即使status为0也能正确筛选 -->
        <if test="status != null and status != ''">
            AND o.status = #{status}
        </if>
        <!-- 仅按创建时间降序（此时结果已全部满足status条件） -->
        ORDER BY o.create_time DESC
    </select>

    <!-- 查询订单详情 -->
    <!-- 查询订单详情 -->
    <select id="selectOrderDetail" resultType="com.ticket.model.dto.response.OrderDetailResponseDTO">
        SELECT
            o.id,
            o.order_no,
            p.name AS performanceName,
            p.venue AS performanceVenue,
            DATE_FORMAT(s.session_time, '%Y-%m-%d %H:%i') AS sessionTime,
            o.grade_name,
            o.price,
            o.count,
            o.total_amount,
            os.status_desc AS statusDesc,
            o.create_time,
            o.pay_time,
            o.cancel_time,
            o.expire_time
        FROM `order` o
                 LEFT JOIN performance p ON o.performance_id = p.id
                 LEFT JOIN performance_session s ON o.session_id = s.id
                 LEFT JOIN (
            SELECT 0 AS code, '待支付' AS status_desc UNION ALL
            SELECT 1 AS code, '已支付' AS status_desc UNION ALL
            SELECT 2 AS code, '已取消' AS status_desc UNION ALL
            SELECT 3 AS code, '已完成' AS status_desc UNION ALL
            SELECT 4 AS code, '已退款' AS status_desc
        ) os ON o.status = os.code
        WHERE o.id = #{id}
          AND o.user_id = ${@com.ticket.util.UserContext@getCurrentUserId()}
    </select>

    <!-- 管理员端分页查询订单列表 -->
    <select id="selectAdminOrderPage" resultType="com.ticket.model.dto.response.AdminOrderListResponseDTO">
        SELECT
        o.id,
        o.order_no,
        o.user_id,
        u.username AS userName,
        p.name AS performanceName,
        DATE_FORMAT(s.session_time, '%Y-%m-%d %H:%i') AS sessionTime,
        o.grade_name,
        o.count,
        o.total_amount,
        o.status,
        os.status_desc AS statusDesc,
        o.create_time,
        o.pay_time,
        o.cancel_time,
        o.expire_time
        FROM `order` o
        LEFT JOIN performance p ON o.performance_id = p.id
        LEFT JOIN performance_session s ON o.session_id = s.id
        LEFT JOIN user u ON o.user_id = u.id
        LEFT JOIN (
        SELECT 0 AS code, '待支付' AS status_desc UNION ALL
        SELECT 1 AS code, '已支付' AS status_desc UNION ALL
        SELECT 2 AS code, '已取消' AS status_desc UNION ALL
        SELECT 3 AS code, '已完成' AS status_desc UNION ALL
        SELECT 4 AS code, '已退款' AS status_desc
        ) os ON o.status = os.code
        WHERE 1=1
        <if test="orderNo != null and orderNo != ''">
            AND o.order_no LIKE CONCAT('%', #{orderNo}, '%')
        </if>
        <if test="userId != null">
            AND o.user_id = #{userId}
        </if>
        <if test="performanceId != null">
            AND o.performance_id = #{performanceId}
        </if>
        <if test="status != null">
            AND o.status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (o.order_no LIKE CONCAT('%', #{keyword}, '%') OR p.name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY o.create_time DESC
    </select>

    <!-- 管理员端查询订单详情 -->
    <select id="selectAdminOrderDetail" resultType="com.ticket.model.dto.response.AdminOrderDetailResponseDTO">
        SELECT
        o.id,
        o.order_no,
        o.user_id,
        u.username AS userName,
        u.phone AS userPhone,
        o.performance_id AS performanceId,
        p.name AS performanceName,
        p.venue AS performanceVenue,
        o.session_id AS sessionId,
        DATE_FORMAT(s.session_time, '%Y-%m-%d %H:%i') AS sessionTime,
        o.ticket_grade_id AS ticketGradeId,
        o.grade_name,
        o.price,
        o.count,
        o.total_amount,
        o.status,
        os.status_desc AS statusDesc,
        o.create_time,
        o.pay_time,
        o.cancel_time,
        o.expire_time
        FROM `order` o
        LEFT JOIN performance p ON o.performance_id = p.id
        LEFT JOIN performance_session s ON o.session_id = s.id
        LEFT JOIN user u ON o.user_id = u.id
        LEFT JOIN (
        SELECT 0 AS code, '待支付' AS status_desc UNION ALL
        SELECT 1 AS code, '已支付' AS status_desc UNION ALL
        SELECT 2 AS code, '已取消' AS status_desc UNION ALL
        SELECT 3 AS code, '已完成' AS status_desc UNION ALL
        SELECT 4 AS code, '已退款' AS status_desc
        ) os ON o.status = os.code
        WHERE o.id = #{id}
    </select>
</mapper>